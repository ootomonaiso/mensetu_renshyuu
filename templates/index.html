<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢æ¥ç·´ç¿’ã‚·ã‚¹ãƒ†ãƒ  - éŸ³å£°éŒ²éŸ³ãƒ»åˆ†æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 48px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a202c;
            margin-bottom: 8px;
            font-size: 2.2em;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        .subtitle {
            color: #718096;
            margin-bottom: 40px;
            font-size: 1.05em;
        }
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 24px;
        }
        .status.idle { background: #e2e8f0; color: #475569; }
        .status.recording { background: #fee2e2; color: #dc2626; animation: pulse 1.5s infinite; }
        .status.processing { background: #fef3c7; color: #d97706; }
        .status.complete { background: #d1fae5; color: #059669; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .control-panel {
            margin-bottom: 30px;
        }
        button {
            padding: 14px 28px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.15s;
            width: 100%;
            margin-bottom: 12px;
        }
        button.start {
            background: #2563eb;
            color: white;
        }
        button.start:hover {
            background: #1d4ed8;
        }
        button.start:active {
            transform: scale(0.98);
        }
        button.stop {
            background: #dc2626;
            color: white;
        }
        button.stop:hover {
            background: #b91c1c;
        }
        button.stop:active {
            transform: scale(0.98);
        }
        button:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        .timer {
            font-size: 3em;
            font-weight: 300;
            color: #1e293b;
            text-align: center;
            margin: 32px 0;
            font-family: ui-monospace, 'SF Mono', Menlo, monospace;
            letter-spacing: 0.05em;
        }
        
        .status-message {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #475569;
            text-align: center;
        }
        
        .result {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
        }
        .result h3 {
            color: #111827;
            margin-bottom: 16px;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .result-text {
            line-height: 1.8;
            color: #374151;
            font-size: 1em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .emotion-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        .emotion-label {
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        .emotion-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .emotion-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .emotion-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .report-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #111827;
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.15s;
            margin-top: 24px;
        }
        .report-link:hover {
            background: #1f2937;
            transform: translateY(-1px);
        }
        .report-link:active {
            transform: scale(0.98);
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ é¢æ¥ç·´ç¿’ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p class="subtitle">éŒ²éŸ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é¢æ¥ç·´ç¿’ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
        
        <div class="status idle" id="status">å¾…æ©Ÿä¸­</div>
        
        <div class="timer" id="timer">00:00</div>
        
        <div class="control-panel">
            <button class="start" id="startBtn" onclick="startRecording()">ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
            <button class="stop hidden" id="stopBtn" onclick="stopRecording()">â¹ï¸ åœæ­¢ã—ã¦åˆ†æ</button>
        </div>
        
        <div class="status-message hidden" id="statusMessage"></div>
        
        <div class="result hidden" id="transcriptResult">
            <h3>ğŸ“ æ–‡å­—èµ·ã“ã—çµæœ</h3>
            <div class="result-text" id="transcriptText"></div>
        </div>
        
        <div class="result hidden" id="speakerTimeline">
            <h3>ğŸ‘¥ è©±è€…ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
            <div id="timelineContent" style="font-family: ui-monospace, monospace; font-size: 14px; line-height: 1.8;"></div>
        </div>
        
        <div class="result hidden" id="voiceQualityResult">
            <h3>ğŸ­ å£°è³ªåˆ†æï¼ˆVoiceMindé¢¨ï¼‰</h3>
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 18px; font-weight: bold; color: #3b82f6; margin-bottom: 8px;" id="personalityType">-</div>
                <div style="font-size: 14px; color: #64748b;">å¹³å‡ã‚¹ã‚³ã‚¢: <span id="avgScore">-</span></div>
            </div>
            <canvas id="radarChart" width="400" height="400" style="max-width: 100%; margin: 0 auto; display: block;"></canvas>
            <div style="margin-top: 16px; padding: 12px; background: #f1f5f9; border-radius: 8px; text-align: center;">
                <strong>æœ€ã‚‚å¼·ã„ç‰¹æ€§:</strong> <span id="dominantTrait" style="color: #3b82f6;">-</span>
            </div>
        </div>
        
        <a href="#" class="report-link hidden" id="reportLink" target="_blank">ğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã</a>
    </div>
    
    <script>
        let ws = null;
        let audioContext = null;
        let processor = null;
        let stream = null;
        let startTime = null;
        let timerInterval = null;
        
        function updateStatus(text, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = 'status ' + className;
        }
        
        function showMessage(text) {
            const msgEl = document.getElementById('statusMessage');
            msgEl.textContent = text;
            msgEl.classList.remove('hidden');
        }
        
        function hideMessage() {
            document.getElementById('statusMessage').classList.add('hidden');
        }
        
        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function translateTrait(trait) {
            const translations = {
                'social': 'ç¤¾ä¼šæ€§', 'action': 'è¡Œå‹•æ€§', 'emotion': 'æ„Ÿæƒ…æ€§',
                'instinct': 'æœ¬èƒ½æ€§', 'presence': 'å­˜åœ¨æ„Ÿ', 'self_expression': 'è‡ªå·±è¡¨ç¾',
                'harmony': 'åŒèª¿æ€§', 'balance': 'èª¿å’Œæ€§', 'adaptation': 'é †å¿œæ€§',
                'thinking': 'æ€è€ƒæ€§', 'analysis': 'åˆ†ææ€§', 'sensation': 'æ„Ÿè¦šæ€§'
            };
            return translations[trait] || trait;
        }
        
        function drawRadarChart(dimensions) {
            const canvas = document.getElementById('radarChart');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 60;
            
            // ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ãƒ‡ãƒ¼ã‚¿
            const labels = ['ç¤¾ä¼šæ€§', 'è¡Œå‹•æ€§', 'æ„Ÿæƒ…æ€§', 'æœ¬èƒ½æ€§', 'å­˜åœ¨æ„Ÿ', 'è‡ªå·±è¡¨ç¾', 
                           'åŒèª¿æ€§', 'èª¿å’Œæ€§', 'é †å¿œæ€§', 'æ€è€ƒæ€§', 'åˆ†ææ€§', 'æ„Ÿè¦šæ€§'];
            const keys = ['social', 'action', 'emotion', 'instinct', 'presence', 'self_expression',
                         'harmony', 'balance', 'adaptation', 'thinking', 'analysis', 'sensation'];
            const values = keys.map(k => dimensions[k]);
            const angles = keys.map((_, i) => (Math.PI * 2 * i / 12) - Math.PI / 2);
            
            // ã‚°ãƒªãƒƒãƒ‰æç”»(5æ®µéš)
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let level = 1; level <= 5; level++) {
                ctx.beginPath();
                const r = radius * level / 5;
                angles.forEach((angle, i) => {
                    const x = centerX + r * Math.cos(angle);
                    const y = centerY + r * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.closePath();
                ctx.stroke();
            }
            
            // è»¸ç·š
            ctx.strokeStyle = '#cbd5e1';
            angles.forEach(angle => {
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX + radius * Math.cos(angle), centerY + radius * Math.sin(angle));
                ctx.stroke();
            });
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ­ãƒƒãƒˆ
            ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            values.forEach((value, i) => {
                const r = radius * value / 100;
                const x = centerX + r * Math.cos(angles[i]);
                const y = centerY + r * Math.sin(angles[i]);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#1e293b';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            labels.forEach((label, i) => {
                const labelRadius = radius + 30;
                const x = centerX + labelRadius * Math.cos(angles[i]);
                const y = centerY + labelRadius * Math.sin(angles[i]);
                ctx.fillText(label, x, y);
            });
        }
        
        async function startRecording() {
            try {
                // ãƒã‚¤ã‚¯å–å¾—
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1
                    }
                });
                
                // WebSocketæ¥ç¶š
                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(`${protocol}//${location.host}/ws/record`);
                
                ws.onopen = () => {
                    updateStatus('éŒ²éŸ³ä¸­', 'recording');
                    document.getElementById('startBtn').classList.add('hidden');
                    document.getElementById('stopBtn').classList.remove('hidden');
                    hideMessage();
                    
                    // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
                    startTime = Date.now();
                    timerInterval = setInterval(updateTimer, 1000);
                    
                    // çµæœã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('transcriptResult').classList.add('hidden');
                    document.getElementById('speakerTimeline').classList.add('hidden');
                    document.getElementById('voiceQualityResult').classList.add('hidden');
                    document.getElementById('reportLink').classList.add('hidden');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'status') {
                        showMessage(data.message);
                    } else if (data.type === 'complete') {
                        // æ–‡å­—èµ·ã“ã—è¡¨ç¤º
                        document.getElementById('transcriptText').textContent = data.transcript;
                        document.getElementById('transcriptResult').classList.remove('hidden');
                        
                        // è©±è€…ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
                        if (data.speakers && data.speakers.length > 0) {
                            const timelineHtml = data.speakers.map(seg => {
                                const duration = (seg.end - seg.start).toFixed(1);
                                const color = seg.speaker === 'SPEAKER_00' ? '#3b82f6' : '#10b981';
                                return `<div style="margin: 8px 0; padding: 8px; background: ${color}20; border-left: 3px solid ${color}; border-radius: 4px;">
                                    <strong style="color: ${color};">${seg.speaker}</strong>: 
                                    ${seg.start.toFixed(1)}s â”â”â” ${seg.end.toFixed(1)}s 
                                    <span style="color: #64748b;">(${duration}ç§’)</span>
                                </div>`;
                            }).join('');
                            document.getElementById('timelineContent').innerHTML = timelineHtml;
                            document.getElementById('speakerTimeline').classList.remove('hidden');
                        }
                        
                        // å£°è³ªåˆ†æãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
                        if (data.voice_quality) {
                            const vq = data.voice_quality;
                            document.getElementById('personalityType').textContent = vq.summary.personality_type;
                            document.getElementById('avgScore').textContent = vq.summary.average.toFixed(1);
                            document.getElementById('dominantTrait').textContent = translateTrait(vq.summary.dominant_trait) + ' (' + vq.summary.dominant_score + 'ç‚¹)';
                            
                            drawRadarChart(vq.dimensions);
                            document.getElementById('voiceQualityResult').classList.remove('hidden');
                        }
                        
                        // ãƒ¬ãƒãƒ¼ãƒˆãƒªãƒ³ã‚¯
                        const reportLink = document.getElementById('reportLink');
                        reportLink.href = data.report_url;
                        reportLink.classList.remove('hidden');
                        
                        updateStatus('åˆ†æå®Œäº†', 'complete');
                        hideMessage();
                    } else if (data.type === 'error') {
                        showMessage('ã‚¨ãƒ©ãƒ¼: ' + data.message);
                        updateStatus('ã‚¨ãƒ©ãƒ¼', 'idle');
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocketã‚¨ãƒ©ãƒ¼:', error);
                    showMessage('æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                };
                
                // éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç† (AudioWorkletã¯è¤‡é›‘ãªãŸã‚ã€ScriptProcessorNodeã‚’ç¶™ç¶šä½¿ç”¨)
                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);
                // ScriptProcessorNode deprecationè­¦å‘Šã¯èªè­˜æ¸ˆã¿ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯AudioWorkletã«ç§»è¡Œæ¨å¥¨
                processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = (e) => {
                    if (!ws || ws.readyState !== WebSocket.OPEN) return;
                    
                    const inputData = e.inputBuffer.getChannelData(0);
                    const int16 = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        int16[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                    }
                    
                    const base64 = btoa(String.fromCharCode(...new Uint8Array(int16.buffer)));
                    ws.send(JSON.stringify({ type: 'audio_chunk', data: base64 }));
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
            } catch (error) {
                alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function stopRecording() {
            if (ws) {
                ws.send(JSON.stringify({ type: 'stop' }));
            }
            
            if (processor) processor.disconnect();
            if (audioContext) audioContext.close();
            if (stream) stream.getTracks().forEach(t => t.stop());
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            updateStatus('å‡¦ç†ä¸­...', 'processing');
            showMessage('éŸ³å£°ã‚’åˆ†æã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...');
            
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
        }
    </script>
</body>
</html>
