# 圧勝面接 - システム仕様書

## ドキュメント情報
- **作成日**: 2025年12月20日
- **バージョン**: 1.0
- **プロジェクト名**: 圧勝面接 (mensetu_renshyuu)

---

## 1. システム概要

### 1.1 システム名称
圧勝面接 - AI音声分析による面接練習支援システム

### 1.2 システムの目的
面接練習における音声を多角的に分析し、客観的なデータに基づいたフィードバックを提供することで、教師と生徒の面接対策を効率化・高品質化する。

### 1.3 対象ユーザー
- 高校・大学の進路指導教員
- 就職・受験を控えた生徒・学生
- 面接練習をサポートする保護者

### 1.4 動作環境

#### 1.4.1 サーバー要件
- **OS**: Windows 10/11, macOS 11+, Ubuntu 20.04+
- **CPU**: Intel Core i5 以上 / Apple M1 以上
- **メモリ**: 8GB 以上推奨（最小4GB）
- **ストレージ**: 5GB 以上の空き容量
- **Python**: 3.9 以上

#### 1.4.2 クライアント要件
- **Webブラウザ**: 
  - Google Chrome 90+
  - Microsoft Edge 90+
  - Firefox 88+
  - Safari 14+
- **マイク**: 録音機能使用時に必要

#### 1.4.3 ネットワーク要件
- **初回セットアップ**: インターネット接続必須（モデルダウンロード）
- **通常利用**: オフライン動作可能（Ollamaモデルダウンロード済みの場合）

---

## 2. 機能要件

### 2.1 音声入力機能

#### 2.1.1 ファイルアップロード
- **機能ID**: F-001
- **機能名**: 音声ファイルアップロード
- **概要**: ユーザーが録音済み音声ファイルをアップロード
- **対応フォーマット**: WAV, MP3, M4A, OGG, FLAC
- **ファイルサイズ上限**: 100MB
- **入力制約**: 
  - ファイル名に特殊文字を含まない
  - 時間制限: 1秒〜60分

#### 2.1.2 ブラウザ録音
- **機能ID**: F-002
- **機能名**: ブラウザからの直接録音
- **概要**: マイクを使用してブラウザから直接録音
- **対応API**: Web Audio API, MediaRecorder API
- **録音形式**: WAV (16-bit, 16kHz)
- **最大録音時間**: 60分

### 2.2 音声処理機能

#### 2.2.1 文字起こし
- **機能ID**: F-003
- **機能名**: 音声→テキスト変換
- **概要**: OpenAI Whisperによる高精度日本語文字起こし
- **使用モデル**: `medium` (デフォルト)
- **精度**: 日本語認識率 95%以上（標準語の場合）
- **出力形式**: JSON（テキスト + タイムスタンプ）
- **処理時間**: 5分の音声で約1〜2分

**入力**:
```
音声ファイルパス: str
```

**出力例**:
```json
{
  "text": "本日はよろしくお願いいたします。",
  "segments": [
    {
      "start": 0.5,
      "end": 3.2,
      "text": "本日はよろしくお願いいたします。"
    }
  ]
}
```

#### 2.2.2 話者分離
- **機能ID**: F-004
- **機能名**: 話者識別
- **概要**: pyannote.audioによる話者の自動識別
- **検出可能話者数**: 1〜3人（設定可能）
- **精度**: 話者識別精度 90%以上（明瞭な音声の場合）
- **話者ラベル**: "SPEAKER_00", "SPEAKER_01" 等
- **教師/生徒の判定**: 発話時間が長い方を「教師」と推定

**出力例**:
```json
[
  {
    "start": 0.5,
    "end": 3.2,
    "speaker": "SPEAKER_00",
    "role": "教師"
  },
  {
    "start": 3.5,
    "end": 7.8,
    "speaker": "SPEAKER_01",
    "role": "生徒"
  }
]
```

#### 2.2.3 音声特徴分析
- **機能ID**: F-005
- **機能名**: 音声特徴量抽出
- **概要**: librosaによる音声の物理的特徴の抽出

**分析項目**:

| 特徴量 | 説明 | 単位 | 正常範囲（参考） |
|--------|------|------|------------------|
| ピッチ（平均） | 声の高さの平均値 | Hz | 男性: 100-150 Hz, 女性: 180-250 Hz |
| ピッチ（標準偏差） | 声の抑揚の度合い | Hz | 20-50 Hz（適度な抑揚） |
| 音量（RMS） | 音の大きさ | dB | -30〜-10 dB |
| 話速 | 1分間あたりの文字数 | 文字/分 | 300-400文字/分（適切な速度） |
| ゼロ交差率 | 音声の明瞭さ | - | 0.05-0.15（明瞭な発音） |
| スペクトル重心 | 声の明るさ | Hz | 1000-3000 Hz |

**出力例**:
```json
{
  "overall": {
    "duration": 120.5,
    "speaking_rate": 350.2
  },
  "by_speaker": {
    "教師": {
      "pitch_mean": 180.5,
      "pitch_std": 35.2,
      "volume_mean": -18.3,
      "speaking_rate": 320.5,
      "zero_crossing_rate": 0.08,
      "spectral_centroid": 2100.3
    },
    "生徒": {
      "pitch_mean": 220.8,
      "pitch_std": 42.1,
      "volume_mean": -22.1,
      "speaking_rate": 380.9,
      "zero_crossing_rate": 0.12,
      "spectral_centroid": 2450.6
    }
  }
}
```

#### 2.2.4 感情分析
- **機能ID**: F-006
- **機能名**: 声のトーン・感情推定
- **概要**: 音声特徴から感情状態を推定

**推定項目**:

| 指標 | 計算方法 | スコア範囲 |
|------|----------|-----------|
| 自信度 | ピッチ安定度 + 音量 + スペクトル重心 | 0.0-1.0 |
| 緊張度 | ゼロ交差率 + ピッチ変動 | 0.0-1.0 |
| 落ち着き度 | 話速の安定度 + 音量変動 | 0.0-1.0 |
| 明瞭度 | ゼロ交差率 + スペクトル特性 | 0.0-1.0 |

**出力例**:
```json
{
  "生徒": {
    "confidence": 0.65,
    "tension": 0.72,
    "calmness": 0.58,
    "clarity": 0.80
  }
}
```

### 2.3 AI処理機能

#### 2.3.1 日本語補正
- **機能ID**: F-007
- **機能名**: 文法・誤字脱字の修正
- **概要**: Ollama (Llama 3.2) による日本語の自動補正
- **処理対象**: 文字起こし結果のテキスト
- **補正内容**: 
  - 誤字脱字の修正
  - 文法の整備
  - 不自然な表現の改善

**入力**:
```
「えーと、本日は、その、よろしくお願いします、はい。」
```

**出力**:
```
「本日はよろしくお願いいたします。」
```

#### 2.3.2 敬語評価
- **機能ID**: F-008
- **機能名**: 敬語の適切性チェック
- **概要**: 面接シーンに適した敬語使用かを評価

**評価項目**:
- 尊敬語・謙譲語の使い分け
- 不適切な口語表現（「〜じゃん」「〜っす」等）
- 若者言葉・スラングの検出
- ビジネスマナー上の問題

**出力例**:
```json
{
  "segments": [
    {
      "speaker": "生徒",
      "original_text": "御社に入社したいです。",
      "issues": [
        {
          "type": "敬語ミス",
          "location": "入社したいです",
          "suggestion": "入社させていただきたく存じます",
          "severity": "中"
        }
      ],
      "score": 75
    }
  ],
  "overall_score": 78,
  "summary": "敬語の基本は理解されていますが、より丁寧な表現を心がけましょう。"
}
```

### 2.4 レポート生成機能

#### 2.4.1 HTMLレポート
- **機能ID**: F-009
- **機能名**: HTMLレポート生成
- **概要**: 分析結果を見やすいHTML形式で出力

**レポート構成**:
1. **ヘッダー**: ファイル名、日時、総時間
2. **サマリー**: 総合評価、主要指標の概要
3. **文字起こし**: 話者別の発話内容
4. **音声分析結果**: グラフ・チャート
5. **敬語評価**: 問題箇所の指摘
6. **改善提案**: 具体的なアドバイス

**グラフ種類**:
- ピッチの時系列変化（折れ線グラフ）
- 音量の推移（折れ線グラフ）
- 感情スコア（レーダーチャート）
- 話速の比較（棒グラフ）

#### 2.4.2 PDFエクスポート
- **機能ID**: F-010
- **機能名**: PDF出力
- **概要**: レポートをPDF形式で保存
- **フォント**: 日本語対応フォント使用
- **レイアウト**: A4サイズ、余白適切

### 2.5 データ管理機能

#### 2.5.1 履歴管理
- **機能ID**: F-011
- **機能名**: 面接履歴の保存
- **概要**: 過去の面接練習データをデータベースに保存
- **保存項目**: 
  - ファイル名
  - 処理日時
  - 処理ステータス
  - 分析結果（音声特徴、敬語スコア）
  - レポートパス

#### 2.5.2 データ削除
- **機能ID**: F-012
- **機能名**: 古いデータの削除
- **概要**: プライバシー保護のため、古い録音ファイルを削除
- **削除基準**: 30日以上経過したファイル（設定可能）
- **自動削除**: オプションで有効化

---

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### 3.1.1 応答時間
| 処理 | 目標時間 | 最大許容時間 |
|------|----------|-------------|
| ファイルアップロード | 1秒以内 | 3秒 |
| 文字起こし（5分音声） | 1〜2分 | 5分 |
| 話者分離（5分音声） | 30秒〜1分 | 3分 |
| 音声分析 | 10〜30秒 | 1分 |
| レポート生成 | 5〜10秒 | 30秒 |

#### 3.1.2 スループット
- 同時処理数: 1セッション（ローカル実行のため）
- 1日あたりの処理件数: 制限なし

#### 3.1.3 リソース使用量
- CPU使用率: 処理中は最大80%
- メモリ使用量: 最大4GB（Whisper + pyannote.audio）
- ディスク使用量: 1回の処理で約500MB〜1GB

### 3.2 可用性要件
- **稼働時間**: ローカル実行のため、ユーザーが起動した時のみ動作
- **エラー復旧**: 処理失敗時はエラーメッセージを表示し、データベースに記録
- **データバックアップ**: ユーザーが手動でバックアップ

### 3.3 セキュリティ要件

#### 3.3.1 データ保護
- **暗号化**: データベース内のテキストデータは暗号化なし（ローカル実行のため）
- **アクセス制限**: 127.0.0.1（localhost）のみアクセス可能
- **外部通信**: 一切の外部API送信なし（完全ローカル処理）

#### 3.3.2 入力検証
- ファイルサイズチェック
- ファイル形式検証
- パストラバーサル攻撃の防止

#### 3.3.3 プライバシー
- **データ保存場所**: ユーザーのローカルディスクのみ
- **匿名化**: レポートには個人を特定する情報を含めない
- **削除機能**: ユーザーがいつでもデータを削除可能

### 3.4 拡張性要件
- **モジュール追加**: プラグイン方式で新機能を追加可能
- **多言語対応**: 英語・中国語への拡張が容易な設計
- **クラウド化**: 将来的にWebサービス化が可能な設計

### 3.5 保守性要件
- **コード品質**: PEP 8準拠、型ヒント使用
- **ドキュメント**: すべての関数にdocstring
- **ログ出力**: 各処理ステップでログ記録
- **エラーハンドリング**: 適切な例外処理

### 3.6 ユーザビリティ要件
- **学習コスト**: 初回利用で5分以内に操作方法を理解可能
- **操作性**: ワンクリックでアップロード・録音開始
- **視認性**: グラフ・チャートで直感的に理解可能
- **アクセシビリティ**: 画面リーダー対応（将来）

---

## 4. インターフェース仕様

### 4.1 ユーザーインターフェース

#### 4.1.1 メイン画面
- **URL**: `http://127.0.0.1:8000/`
- **要素**:
  - タイトル: "圧勝面接 - AI面接練習分析ツール"
  - ファイルアップロードエリア（ドラッグ&ドロップ対応）
  - 録音ボタン（「録音開始」「停止」）
  - 処理状況表示（プログレスバー）
  - 過去のレポート一覧

#### 4.1.2 レポート画面
- **URL**: `http://127.0.0.1:8000/reports/{interview_id}`
- **要素**:
  - サマリーカード（総合評価）
  - 文字起こしテキスト（話者別、色分け）
  - 音声分析グラフ（ピッチ、音量、話速）
  - 感情分析チャート（レーダーチャート）
  - 敬語評価セクション（問題箇所を赤字で表示）
  - ダウンロードボタン（HTML, PDF）

### 4.2 API仕様
詳細は [API仕様書](./api_specification.md) を参照

---

## 5. データ仕様

### 5.1 データベース仕様
詳細は [データベース設計書](./database_design.md) を参照

### 5.2 ファイル構造

```
mensetu_renshyuu/
├── data/
│   ├── uploads/           # 音声ファイル保存
│   │   └── interview_20251220_143000_sample.wav
│   ├── reports/           # HTMLレポート保存
│   │   └── report_1_20251220_143500.html
│   └── interviews.db      # SQLiteデータベース
├── static/                # 静的ファイル
├── templates/             # HTMLテンプレート
├── src/                   # ソースコード
└── app.py                 # メインアプリケーション
```

---

## 6. エラーコード一覧

| コード | 説明 | 対処方法 |
|--------|------|----------|
| E-001 | ファイルアップロード失敗 | ファイルサイズ・形式を確認 |
| E-002 | Whisper初期化失敗 | Whisperモデルを再ダウンロード |
| E-003 | pyannote.audio初期化失敗 | HuggingFaceトークンを確認 |
| E-004 | Ollama接続失敗 | Ollamaが起動しているか確認 |
| E-005 | 文字起こし失敗 | 音声ファイルが破損していないか確認 |
| E-006 | 話者分離失敗 | 音声品質が低い可能性、再録音を推奨 |
| E-007 | 音声分析失敗 | ファイル形式を確認 |
| E-008 | レポート生成失敗 | ディスク容量を確認 |
| E-009 | データベースエラー | データベースファイルの権限を確認 |
| E-010 | メモリ不足 | 他のアプリケーションを終了 |

---

## 7. 制約事項

### 7.1 技術的制約
- **話者数**: 最大3人まで対応（それ以上は精度低下）
- **音声時間**: 最大60分（それ以上は処理時間が長い）
- **同時処理**: 1セッションのみ（並列処理非対応）
- **オフライン利用**: Ollamaモデルを事前ダウンロード必要

### 7.2 運用制約
- **初回セットアップ**: インターネット接続必須（約3GB ダウンロード）
- **言語**: 日本語のみ対応（他言語は精度低下）
- **録音環境**: 静かな環境を推奨（雑音が多いと精度低下）

### 7.3 法的制約
- **録音の同意**: 録音前に被録音者の同意を取得すること
- **プライバシー**: 個人情報の取り扱いに注意
- **著作権**: オープンソースライセンスに準拠

---

## 8. テスト要件

### 8.1 機能テスト
- 全機能（F-001〜F-012）の動作確認
- 各エラーコードの発生確認

### 8.2 性能テスト
- 5分、10分、30分の音声での処理時間測定
- メモリ使用量の測定

### 8.3 互換性テスト
- 各種ブラウザでの動作確認
- Windows/Mac/Linuxでの動作確認

詳細は [テスト計画書](./test_plan.md) を参照

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| 話者分離 | 音声から複数の話者を識別し、発話を区別する技術 |
| 文字起こし | 音声をテキストに変換する処理 |
| ピッチ | 声の高さ、周波数 (Hz) で表現 |
| RMS | Root Mean Square、音量の大きさを表す指標 |
| ゼロ交差率 | 音声波形が0を横切る頻度、発音の明瞭さと関連 |
| スペクトル重心 | 周波数スペクトルの重心、声の明るさと関連 |
| Whisper | OpenAI が開発した音声認識モデル |
| pyannote.audio | 話者分離・識別のためのPythonライブラリ |
| Ollama | ローカルで動作するLLM実行環境 |
| librosa | Pythonの音声分析ライブラリ |

---

## 10. 参考資料

- [開発設計書](./design_document.md)
- [API仕様書](./api_specification.md)
- [データベース設計書](./database_design.md)
- [テスト計画書](./test_plan.md)
- [ユーザーマニュアル](../README.md)

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|----------|------|---------|-------|
| 1.0 | 2025-12-20 | 初版作成 | - |

---

**文書ステータス**: 承認済み
**次回レビュー日**: 2026-01-20
