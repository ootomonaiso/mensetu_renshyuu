name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.2.3 ãªã©ã®ã‚¿ã‚°ã«ãƒãƒƒãƒ

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Get tag version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        run: |
          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # æœ€åˆã®ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆ
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            # å‰å›ã®ã‚¿ã‚°ã‹ã‚‰ã®å¤‰æ›´ã‚’å–å¾—
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi
          
          # è¤‡æ•°è¡Œã®å‡ºåŠ›ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          {
            echo 'CHANGELOG<<EOF'
            echo "$CHANGELOG"
            echo EOF
          } >> $GITHUB_OUTPUT
      
      - name: Create Release Archive
        run: |
          # ãƒªãƒªãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
          mkdir -p release-package
          
          # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          cp -r src release-package/
          cp -r static release-package/
          cp -r templates release-package/
          cp app.py release-package/
          cp requirements.txt release-package/
          cp README.md release-package/
          cp SETUP.md release-package/
          
          # .env.exampleãŒã‚ã‚Œã°ã‚³ãƒ”ãƒ¼
          [ -f .env.example ] && cp .env.example release-package/ || true
          
          # dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€ ã‚’ä½œæˆï¼ˆç©ºã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰
          mkdir -p release-package/data/uploads
          mkdir -p release-package/data/reports
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
          cd release-package
          tar -czf ../mensetu_renshyuu-${{ steps.get_version.outputs.VERSION }}.tar.gz .
          cd ..
          zip -r mensetu_renshyuu-${{ steps.get_version.outputs.VERSION }}.zip release-package/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            # é¢æ¥ç·´ç¿’ãƒ¬ãƒãƒ¼ãƒˆæ”¯æ´ãƒ„ãƒ¼ãƒ« ${{ steps.get_version.outputs.VERSION }}
            
            ## ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            
            1. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
            2. README.md ã®æ‰‹é †ã«å¾“ã£ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            3. `python app.py` ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
            
            ## ğŸ“ å¤‰æ›´å†…å®¹
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ## ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
            
            - Python 3.9ä»¥ä¸Š
            - FFmpeg
            - Ollama
            
            è©³ç´°ã¯ [README.md](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.VERSION }}/README.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          files: |
            mensetu_renshyuu-${{ steps.get_version.outputs.VERSION }}.tar.gz
            mensetu_renshyuu-${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
